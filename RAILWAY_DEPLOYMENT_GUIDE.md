# Emotional Journal - Railway Deployment Guide

## Issue with Provided Token

The Railway token provided (`b041cbc3-e1a1-4ffd-a0f8-2497ad5d41b5`) appears to be invalid or expired. Railway tokens typically have a different format and may have limited scope.

**To proceed with Railway deployment, you need:**

1. A valid Railway API token from your Railway account
2. Access to create a new project in Railway

---

## Step-by-Step Railway Deployment Instructions

### Step 1: Get a Valid Railway Token

1. Go to [railway.app](https://railway.app)
2. Sign in to your Railway account
3. Go to **Account Settings** → **Tokens**
4. Click **Create New Token**
5. Copy the generated token (it will look like: `rw_...`)

### Step 2: Install Railway CLI

```bash
npm install -g @railway/cli
```

### Step 3: Authenticate with Railway

```bash
export RAILWAY_TOKEN=<your-valid-token>
railway login --browserless
```

Or use the token directly:

```bash
export RAILWAY_TOKEN=<your-valid-token>
```

### Step 4: Create a New Railway Project

```bash
cd /home/ubuntu/emotional-journal
railway init --name emotional-journal
```

When prompted:
- Select "Create a new project"
- Choose a region (e.g., US)
- Select "Node.js" as the runtime

### Step 5: Add Environment Variables

```bash
railway variable set BOT_TOKEN 8487391500:AAFJ6FyBecjkGTy9hbeyb5ehy7FgDVpY4jA
railway variable set NODE_ENV production
railway variable set PORT 3000
```

### Step 6: Add Database (PostgreSQL or MySQL)

```bash
# Add PostgreSQL
railway add --service postgres

# Or add MySQL
railway add --service mysql
```

### Step 7: Deploy

```bash
railway up
```

### Step 8: Get the Deployed URL

```bash
railway open
```

Or check the Railway dashboard for your app URL.

---

## Alternative: Manual Railway Deployment via Web Dashboard

If the CLI has issues, you can deploy via the Railway web interface:

### 1. Create Project
- Go to [railway.app](https://railway.app)
- Click "New Project"
- Select "Deploy from GitHub" or "Empty Project"

### 2. Connect Repository
- Connect your GitHub account
- Select the emotional-journal repository
- Or upload the source code manually

### 3. Configure Services

#### Service 1: Node.js Backend
- **Build Command:** `pnpm install && pnpm build`
- **Start Command:** `pnpm start`
- **Port:** 3000

#### Service 2: Database
- Add PostgreSQL or MySQL service
- Railway will auto-generate DATABASE_URL

### 4. Set Environment Variables
In the Railway dashboard, add:

```
BOT_TOKEN=8487391500:AAFJ6FyBecjkGTy9hbeyb5ehy7FgDVpY4jA
NODE_ENV=production
PORT=3000
JWT_SECRET=<generate-random-string>
VITE_APP_ID=<from-manus>
OAUTH_SERVER_URL=<from-manus>
VITE_OAUTH_PORTAL_URL=<from-manus>
VITE_FRONTEND_FORGE_API_URL=<from-manus>
VITE_FRONTEND_FORGE_API_KEY=<from-manus>
BUILT_IN_FORGE_API_URL=<from-manus>
BUILT_IN_FORGE_API_KEY=<from-manus>
OWNER_OPEN_ID=<your-id>
OWNER_NAME=<your-name>
```

### 5. Deploy
- Click "Deploy"
- Railway will build and deploy automatically

### 6. Get URL
- Once deployed, Railway provides a public URL
- Format: `https://emotional-journal-production-xxxx.railway.app`

---

## Project Structure for Railway

The project is already configured for Railway deployment:

```
emotional-journal/
├── package.json                    # npm scripts for build/start
├── server/
│   ├── _core/index.ts             # Express server entry point
│   ├── telegram-bot.ts            # Telegram bot handler
│   ├── notification-service.ts    # Background jobs
│   └── routers.ts                 # tRPC API endpoints
├── client/
│   ├── src/                       # React frontend
│   └── dist/                      # Built frontend (generated)
├── drizzle/
│   └── schema.ts                  # Database schema
├── railway.json                   # Railway configuration
└── vite.config.ts                 # Vite build config
```

---

## Build and Start Commands

### Build
```bash
pnpm build
```

This command:
1. Builds the React frontend with Vite
2. Bundles the Node.js backend with esbuild
3. Outputs to `dist/` directory

### Start
```bash
pnpm start
```

This command:
1. Starts the Express server on port 3000
2. Initializes the Telegram bot
3. Starts background notification jobs
4. Serves the React frontend

---

## Database Setup on Railway

### Option 1: PostgreSQL (Recommended)
```bash
railway add --service postgres
```

Then update `DATABASE_URL` to use PostgreSQL connection string.

### Option 2: MySQL
```bash
railway add --service mysql
```

The connection string is auto-generated by Railway.

### Run Migrations
After database is created:

```bash
railway run pnpm db:push
```

This will:
1. Generate Drizzle migrations
2. Apply them to the database
3. Create all tables

---

## Telegram Bot Configuration

### Bot Polling (Current Setup)
The bot uses long-polling to check for messages. This works on Railway without additional configuration.

### Bot Webhook (Optional)
For better performance, you can switch to webhook mode:

1. Update `server/telegram-bot.ts` to use webhook instead of polling
2. Set webhook URL to: `https://<your-railway-url>/api/telegram/webhook`
3. Configure in Telegram Bot API

---

## Environment Variables Explained

| Variable | Purpose | Required |
|----------|---------|----------|
| `BOT_TOKEN` | Telegram bot API token | ✅ Yes |
| `DATABASE_URL` | Database connection string | ✅ Yes |
| `NODE_ENV` | Environment (production/development) | ✅ Yes |
| `PORT` | Server port (default: 3000) | ✅ Yes |
| `JWT_SECRET` | Session signing secret | ✅ Yes |
| `VITE_APP_ID` | Manus OAuth app ID | ✅ Yes |
| `OAUTH_SERVER_URL` | Manus OAuth server URL | ✅ Yes |
| `VITE_OAUTH_PORTAL_URL` | Manus login portal URL | ✅ Yes |
| `VITE_FRONTEND_FORGE_API_URL` | Manus API URL | ✅ Yes |
| `VITE_FRONTEND_FORGE_API_KEY` | Manus API key | ✅ Yes |
| `BUILT_IN_FORGE_API_URL` | Manus built-in API URL | ✅ Yes |
| `BUILT_IN_FORGE_API_KEY` | Manus built-in API key | ✅ Yes |
| `OWNER_OPEN_ID` | Owner's Manus ID | ✅ Yes |
| `OWNER_NAME` | Owner's name | ✅ Yes |

---

## Monitoring and Logs

### View Logs
```bash
railway logs
```

### Monitor Performance
- CPU usage
- Memory usage
- Network traffic
- Error rates

All available in Railway dashboard.

### Troubleshooting

**Bot not responding:**
- Check `BOT_TOKEN` is correct
- Check logs for polling errors
- Verify Telegram API connectivity

**Database connection errors:**
- Verify `DATABASE_URL` is correct
- Check database service is running
- Run migrations with `pnpm db:push`

**Frontend not loading:**
- Check build completed successfully
- Verify static files are served
- Check browser console for errors

---

## Deployment Checklist

- [ ] Valid Railway token obtained
- [ ] Railway CLI installed
- [ ] Project initialized with `railway init`
- [ ] Database service added
- [ ] Environment variables set
- [ ] Build command configured
- [ ] Start command configured
- [ ] Deployed with `railway up`
- [ ] Public URL obtained
- [ ] Bot token verified
- [ ] Database migrations run
- [ ] Frontend loads successfully
- [ ] Bot responds to messages
- [ ] Notifications working

---

## Expected Deployed URL Format

After successful deployment, your app will be available at:

```
https://emotional-journal-production-<random>.railway.app
```

Or with custom domain:

```
https://your-custom-domain.com
```

---

## Next Steps After Deployment

1. **Test the Bot**
   - Send a message to the bot in Telegram
   - Verify entry is created
   - Click "View" button to open Mini App

2. **Test the Mini App**
   - Visit the deployed URL
   - Sign in with Manus OAuth
   - Create an entry
   - Rate a day
   - Test invite system

3. **Test Notifications**
   - Configure notification settings
   - Wait for daily reminder
   - Verify therapist notifications

4. **Monitor**
   - Check Railway logs regularly
   - Monitor error rates
   - Check database performance

---

## Support Resources

- [Railway Documentation](https://docs.railway.app)
- [Railway CLI Reference](https://docs.railway.app/cli/cli-reference)
- [Emotional Journal Technical Docs](./TECHNICAL_DOCUMENTATION.md)
- [Emotional Journal Source Guide](./SOURCE_CODE_GUIDE.md)

---

## Troubleshooting Common Issues

### "Unauthorized. Please check that your RAILWAY_TOKEN is valid"
- Token may be expired or invalid
- Generate a new token from Railway dashboard
- Ensure token has project creation permissions

### "Build failed"
- Check `pnpm install` completes successfully
- Verify all dependencies are available
- Check Node.js version compatibility

### "Bot not responding"
- Verify BOT_TOKEN is correct
- Check polling logs for errors
- Ensure Telegram API is accessible

### "Database connection failed"
- Verify DATABASE_URL is correct
- Check database service is running
- Run migrations: `railway run pnpm db:push`

### "Frontend not loading"
- Check build completed successfully
- Verify static files in `dist/` directory
- Check browser console for errors

---

## Quick Reference Commands

```bash
# Install Railway CLI
npm install -g @railway/cli

# Set token
export RAILWAY_TOKEN=<your-token>

# Initialize project
railway init --name emotional-journal

# Add database
railway add --service postgres

# Set environment variables
railway variable set BOT_TOKEN <token>

# Deploy
railway up

# View logs
railway logs

# Open dashboard
railway open

# Run command in Railway environment
railway run <command>
```

---

## Summary

The Emotional Journal app is fully configured for Railway deployment. Once you have a valid Railway token:

1. Follow the step-by-step instructions above
2. Deploy with `railway up`
3. Get your public URL from Railway dashboard
4. Set environment variables
5. Run database migrations
6. Test all features

The app will be fully functional with:
- ✅ React Mini App frontend
- ✅ Node.js Express backend
- ✅ Telegram bot with message handling
- ✅ Background notification jobs
- ✅ Database with all tables
- ✅ Client-therapist relationships
- ✅ Day ratings and entry management

All features work seamlessly on Railway's platform!
